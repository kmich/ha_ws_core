name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  preflight:
    name: Preflight checks (lint + hassfest + tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install ruff pytest
          pip install -r requirements_dev.txt

      - name: Ruff lint
        run: ruff check --ignore E701 --output-format=github custom_components/ws_core/

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands

      - name: hassfest
        uses: home-assistant/actions/hassfest@master

      - name: Unit tests
        run: pytest tests/ -v

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: preflight
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Sanity check manifest version matches tag
        run: |
          python - <<'PY'
          import json, pathlib, sys
          tag = "${{ steps.version.outputs.VERSION }}"
          manifest = json.loads(pathlib.Path("custom_components/ws_core/manifest.json").read_text(encoding="utf-8"))
          mv = manifest.get("version")
          if mv != tag:
            print(f"ERROR: manifest.json version {mv!r} != tag {tag!r}")
            sys.exit(1)
          print("OK: manifest version matches tag:", mv)
          PY

      - name: Build release zip
        run: |
          cd custom_components
          zip -r ../ws_core_v${{ steps.version.outputs.VERSION }}.zip ws_core/
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.VERSION }}"
          draft: false
          prerelease: false
          files: ws_core_v${{ steps.version.outputs.VERSION }}.zip
          generate_release_notes: true

